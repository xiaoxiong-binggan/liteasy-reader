<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LitEasy - è®©æ¯ä¸€ç¯‡è®ºæ–‡éƒ½è¯´äººè¯</title>
  <!-- å¼•å…¥ Vue å’Œ PDF.js CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9fb;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .upload-zone {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { color: #1890ff; }
    .reader-layout {
      display: flex;
      height: 70vh;
      gap: 20px;
      margin-top: 20px;
    }
    .pdf-view {
      flex: 3;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: auto;
      background: white;
      position: relative;
    }
    .sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .panel {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button, .action-btn {
      padding: 8px 12px;
      background: #1890ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover, .action-btn:hover { background: #0c7cd5; }
    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 300px;
      font-size: 14px;
    }
    canvas { display: block; margin: 0 auto; }
    .annotation-item {
      font-size: 13px;
      padding: 6px;
      background: #f0f2f5;
      margin: 4px 0;
      border-radius: 4px;
      word-break: break-word;
    }
    .highlight-tip {
      margin-top: 10px;
      padding: 8px;
      background: #e6f7ff;
      border-left: 4px solid #1890ff;
      font-size: 0.9em;
      color: #333;
    }
  </style>
</head>
<body>

<div id="app">
  <!-- é¦–é¡µä¸Šä¼ åŒº -->
  <div v-if="!currentPaper" class="upload-zone">
    <h2>ğŸ“„ ä¸Šä¼ ä½ çš„è‹±æ–‡æ–‡çŒ® PDF</h2>
    <p>æ”¯æŒæœ¬åœ°PDFæ–‡ä»¶ï¼Œç«‹å³ä½“éªŒAIå¯¼è¯»</p>
    <input type="file" accept=".pdf" @change="handleFileUpload" class="action-btn" />
    <p style="color:#666; font-size:0.9em; margin-top:10px;">
      ğŸ‘‰ æç¤ºï¼šå¯ä»¥æ‰¾ä¸€ç¯‡æœºå™¨å­¦ä¹ æˆ–åŒ»å­¦è®ºæ–‡è¯•è¯•çœ‹
    </p>
  </div>

  <!-- ä¸»é˜…è¯»ç•Œé¢ -->
  <div v-else class="reader-layout">
    <!-- å·¦ä¾§ï¼šPDF æ˜¾ç¤º -->
    <div class="pdf-view" ref="pdfContainer"></div>

    <!-- å³ä¾§ï¼šAIè¾…åŠ©åŠŸèƒ½ -->
    <div class="sidebar">
      <!-- AIå¯¼è¯»é¢æ¿ -->
      <div class="panel">
        <h3>ğŸ§  AIä¸ºä½ ç”Ÿæˆã€Œå°ç™½ç‰ˆå¯¼è¯»ã€</h3>
        <p><strong>èƒŒæ™¯ï¼š</strong>{{ aiSummary.background }}</p>
        <p><strong>æ–¹æ³•ï¼š</strong>{{ aiSummary.method }}</p>
        <p><strong>ç»“è®ºï¼š</strong>{{ aiSummary.conclusion }}</p>
        <div class="highlight-tip">
          âœ… å»ºè®®å…ˆçœ‹æ‘˜è¦ã€å›¾3å’Œç»“è®ºéƒ¨åˆ†
        </div>
      </div>

      <!-- æ‰¹æ³¨ç¬”è®° -->
      <div class="panel">
        <h3>ğŸ“Œ æˆ‘çš„ç¬”è®°</h3>
        <div v-if="annotations.length === 0" style="color:#999;">å°šæ— æ‰¹æ³¨ï¼Œé€‰ä¸­æ–‡æœ¬å³å¯æ·»åŠ ï¼</div>
        <div v-for="(note, i) in annotations" :key="i" class="annotation-item">
          [{{ note.type }}] {{ note.text }}
        </div>
      </div>
    </div>
  </div>

  <!-- ç¿»è¯‘/æ‰¹æ³¨å¼¹çª— -->
  <div v-if="showTooltip" class="tooltip" :style="{ top: tooltipY + 'px', left: tooltipX + 'px' }">
    <strong>{{ selectedText }}</strong>
    <div style="margin:8px 0; color:#333;">{{ translation }}</div>
    <button @click="addNote('ä¸æ‡‚')">â“ ä¸æ‡‚</button>
    <button @click="addNote('é‡ç‚¹')">âœ… é‡ç‚¹</button>
  </div>
</div>

<script>
  // è®¾ç½® PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const { createApp, ref, nextTick } = Vue;

  createApp({
    setup() {
      // çŠ¶æ€å˜é‡
      const currentPaper = ref(null);
      const aiSummary = ref({
        background: "ç ”ç©¶äººå‘˜å‘ç°äººå·¥è¯»è®ºæ–‡å¤ªæ…¢ï¼Œæƒ³ç”¨AIå·¥å…·æ¥æé€Ÿã€‚",
        method: "ä»–ä»¬è®­ç»ƒäº†ä¸€ä¸ªæ¨¡å‹ï¼Œèƒ½è‡ªåŠ¨æå–æ ¸å¿ƒè§‚ç‚¹å¹¶é€šä¿—è§£é‡Šã€‚",
        conclusion: "å®éªŒè¯æ˜ï¼Œç”¨æˆ·ç†è§£é€Ÿåº¦æå‡äº†5å€ä»¥ä¸Šã€‚"
      });
      const annotations = ref([]);
      const selectedText = ref('');
      const showTooltip = ref(false);
      const tooltipX = ref(0);
      const tooltipY = ref(0);
      const translation = ref('');

      // å­¦æœ¯è¯­å¯¹ç…§è¡¨ï¼ˆæ¨¡æ‹Ÿç¿»è¯‘ï¼‰
      const termDict = {
        transformer: 'ä¸€ç§æ–°å‹AIç»“æ„ï¼ˆå¦‚ChatGPTæ‰€ç”¨ï¼‰',
        'state-of-the-art': 'å½“å‰æœ€å¥½çš„æŠ€æœ¯æ°´å¹³',
        'attention mechanism': 'æ³¨æ„åŠ›æœºåˆ¶ï¼šAIå­¦ä¼šâ€œæŠ“é‡ç‚¹â€çš„æ–¹æ³•'
      };

      // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
      const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        currentPaper.value = { name: file.name, url };
        
        // ä¸‹ä¸€å¸§æ¸²æŸ“PDF
        await nextTick();
        renderPdf(url);

        // æ¨¡æ‹ŸAIç”Ÿæˆå¯¼è¯»ï¼ˆå»¶è¿Ÿ1ç§’ï¼‰
        setTimeout(() => {
          console.log('AIå¯¼è¯»å·²ç”Ÿæˆ');
        }, 1000);
      };

      // æ¸²æŸ“PDFæ¯ä¸€é¡µ
      const renderPdf = async (url) => {
        const container = document.querySelector('.pdf-view');
        container.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

        try {
          const loadingTask = pdfjsLib.getDocument(url);
          const pdf = await loadingTask.promise;

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport }).promise;
            container.appendChild(canvas);

            // æ·»åŠ å¯é€‰ä¸­æ–‡æœ¬å±‚ï¼ˆç”¨äºè§¦å‘ç¿»è¯‘ï¼‰
            const textLayer = document.createElement('div');
            textLayer.style.position = 'absolute';
            textLayer.style.inset = '0';
            textLayer.style.pointerEvents = 'none';
            textLayer.style.userSelect = 'text';
            canvas.parentNode.insertBefore(textLayer, canvas.nextSibling);
          }

          // å¯ç”¨æ–‡æœ¬é€‰æ‹©äº‹ä»¶
          container.addEventListener('mouseup', onTextSelect);
        } catch (err) {
          alert('PDFåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
          console.error(err);
        }
      };

      // æ–‡æœ¬é€‰ä¸­æ—¶è§¦å‘
      const onTextSelect = () => {
        const sel = window.getSelection();
        const text = sel.toString().trim();
        if (text.length === 0 || text.length > 200) return;

        const range = sel.getRangeAt(0);
        const rect = range.getBoundingClientRect();

        selectedText.value = text;
        tooltipX.value = rect.left;
        tooltipY.value = rect.top - 60;
        showTooltip.value = true;

        // æŸ¥è¯ or ç¿»è¯‘
        const lower = text.toLowerCase();
        translation.value = termDict[lower] || 
                           `è¿™ä¸ªå¥å­çš„æ„æ€æ˜¯ï¼šâ€œ${text.substring(0, 50)}...â€ï¼ˆæ¨¡æ‹Ÿç¿»è¯‘ï¼‰`;

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å¼¹çª—
        const hideTooltip = () => {
          showTooltip.value = false;
          document.removeEventListener('click', hideTooltip);
        };
        setTimeout(() => {
          document.addEventListener('click', hideTooltip, { once: true });
        }, 0);
      };

      // æ·»åŠ æ‰¹æ³¨
      const addNote = (type) => {
        annotations.value.push({
          type,
          text: selectedText.value
        });
        showTooltip.value = false;
      };

      return {
        currentPaper,
        aiSummary,
        annotations,
        showTooltip,
        tooltipX,
        tooltipY,
        selectedText,
        translation,
        handleFileUpload,
        addNote
      };
    }
  }).mount('#app');
</script>

</body>
</html>
